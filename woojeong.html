<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스트리머 미션 현황판</title>
    <!-- OBS 캐시 무력화를 위한 메타 태그 추가 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            font-family: 'Malgun Gothic', sans-serif;
        }
        
        .mission-panel {
            width: 300px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .streamer-header {
            background-color: #2b5797;
            color: white;
            padding: 10px 15px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .streamer-info {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .streamer-avatar {
            width: 60px;
            height: 60px;
            background-color: #ddd;
            margin-right: 15px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .streamer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .streamer-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .streamer-role {
            font-size: 14px;
            color: #666;
        }
        
        .streamer-name {
            font-size: 20px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .mission-section {
            padding: 15px;
        }
        
        .mission-category {
            font-weight: bold;
            background-color: #efefef;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: block;
        }
        
        .main-mission {
            color: #c43e57;
            border-left: 4px solid #c43e57;
        }
        
        .sub-mission {
            color: #b87d2b;
            border-left: 4px solid #b87d2b;
            margin-top: 15px;
        }
        
        .mission-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 0;
        }
        
        .mission-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #aaa;
            border-radius: 3px;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
        }
        
        .mission-checkbox.checked {
            background-color: #44c767;
            border-color: #44c767;
        }
        
        .mission-checkbox.checked:after {
            content: "✓";
            color: white;
            font-weight: bold;
        }
        
        .mission-text {
            font-size: 15px;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="mission-panel">
        <div class="streamer-header" id="streamer-name">스트리머 이름</div>
        
        <div class="streamer-info">
            <div class="streamer-avatar">
                <img id="profile-image" src="./default-avatar.png" alt="프로필 이미지">
            </div>
            <div class="streamer-details">
                <div class="streamer-role">[특이사항]</div>
                <div class="streamer-name" id="streamer-role">역할</div>
            </div>
        </div>
        
        <div class="mission-section">
            <div class="mission-category main-mission">메인 미션</div>
            <div class="mission-item">
                <div class="mission-checkbox" id="check1"></div>
                <div class="mission-text" id="mission1">메인 미션 내용</div>
            </div>
            
            <div class="mission-category sub-mission">서브 미션</div>
            <div class="mission-item">
                <div class="mission-checkbox" id="check2"></div>
                <div class="mission-text" id="mission2">서브 미션 1</div>
            </div>
            <div class="mission-item">
                <div class="mission-checkbox" id="check3"></div>
                <div class="mission-text" id="mission3">서브 미션 2</div>
            </div>
            <div class="mission-item">
                <div class="mission-checkbox" id="check4"></div>
                <div class="mission-text" id="mission4">서브 미션 3</div>
            </div>
        </div>
    </div>

    <script>
        // 스트리머 ID 추출 (파일명에서)
        function getStreamerId() {
            // URL에서 파일명 추출 (예: woojeong.html)
            const path = window.location.pathname;
            const filename = path.substring(path.lastIndexOf('/') + 1);
            
            // 확장자 제거
            return filename.replace('.html', '');
        }
        
        // 브라우저 로컬 스토리지에서 데이터 가져오기
        function getDataFromLocalStorage() {
            const streamerId = getStreamerId();
            const dataKey = `streamer_${streamerId}`;
            
            // 로컬 스토리지에서 데이터 가져오기
            const dataStr = localStorage.getItem(dataKey);
            if (!dataStr) return null;
            
            try {
                return JSON.parse(dataStr);
            } catch (error) {
                console.error('데이터 파싱 중 오류:', error);
                return null;
            }
        }
        
        // 데이터 적용 함수
        function applyData(data) {
            if (!data) return;
            
            // 기본 정보 설정
            document.getElementById('streamer-name').textContent = data.name || getStreamerId();
            document.getElementById('streamer-role').textContent = data.role || '';
            
            // 미션 설정
            document.getElementById('mission1').textContent = data.mission1 || '';
            document.getElementById('mission2').textContent = data.mission2 || '';
            document.getElementById('mission3').textContent = data.mission3 || '';
            document.getElementById('mission4').textContent = data.mission4 || '';
            
            // 체크박스 상태 설정
            if (data.check1 === '1') document.getElementById('check1').classList.add('checked');
            else document.getElementById('check1').classList.remove('checked');
            
            if (data.check2 === '1') document.getElementById('check2').classList.add('checked');
            else document.getElementById('check2').classList.remove('checked');
            
            if (data.check3 === '1') document.getElementById('check3').classList.add('checked');
            else document.getElementById('check3').classList.remove('checked');
            
            if (data.check4 === '1') document.getElementById('check4').classList.add('checked');
            else document.getElementById('check4').classList.remove('checked');
            
            // 이미지 설정 (특별히 처리)
            if (data.image) {
                const img = document.getElementById('profile-image');
                
                // 이미지 로드 에러 처리 추가
                img.onerror = function() {
                    console.error('이미지 로드 실패');
                    img.src = './default-avatar.png'; // 기본 이미지로 대체
                };
                
                // 캐시 방지를 위한 타임스탬프 추가
                img.src = data.image + '?t=' + new Date().getTime();
            }
        }
        
        // 데이터 로드 함수
        function loadData() {
            const data = getDataFromLocalStorage();
            applyData(data);
        }
        
        // 자동 새로고침 설정 (보다 적극적인 방식)
        function setupAutoRefresh() {
            // 강제 새로고침 함수
            function forceRefresh() {
                // 페이지 강제 새로고침 (OBS에서는 이렇게 해야 캐시를 무시함)
                if (window.location.href.indexOf('?') === -1) {
                    window.location.href = window.location.href + '?t=' + new Date().getTime();
                } else {
                    window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                }
            }
            
            // 초기 데이터 로드
            loadData();
            
            // 데이터 변경 감지 및 반영
            let lastDataStr = JSON.stringify(getDataFromLocalStorage() || {});
            
            // 주기적으로 데이터 확인 (500ms마다)
            setInterval(function() {
                const newData = getDataFromLocalStorage();
                const newDataStr = JSON.stringify(newData || {});
                
                // 데이터가 변경되었으면 반영
                if (newDataStr !== lastDataStr) {
                    console.log('데이터 변경 감지, 업데이트 중...');
                    applyData(newData);
                    lastDataStr = newDataStr;
                }
            }, 500);
            
            // 정기적으로 강제 새로고침 (30초마다)
            // OBS의 캐시 문제를 완전히 우회하기 위함
            setInterval(forceRefresh, 30000);
        }
        
        // 페이지 로드 시 초기화
        window.addEventListener('load', setupAutoRefresh);
    </script>
</body>
</html>
