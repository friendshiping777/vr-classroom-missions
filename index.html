<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VR 교실 스트리머 미션 컨트롤러</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDpNNTnTJSML_f50epDmu9mCip3YF-6Ksc",
      authDomain: "friendshiping-ee9a0.firebaseapp.com",
      databaseURL: "https://friendshiping-ee9a0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "friendshiping-ee9a0",
      storageBucket: "friendshiping-ee9a0.appspot.com",
      messagingSenderId: "547703265043",
      appId: "1:547703265043:web:a9d5d00bdb5098ef74b6df"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <style>
    body {
      font-family: 'Malgun Gothic', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    h1 {
      text-align: center;
      color: #2b5797;
      margin-bottom: 30px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .instructions {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .instructions h2 {
      color: #2b5797;
      text-align: center;
    }

    .instructions ol {
      padding-left: 20px;
    }
  </style>
</head>

<body>
  <h1>VR 교실 스트리머 미션 컨트롤러</h1>

  <div class="instructions">
    <h2>사용 방법</h2>
    <ol>
      <li>각 스트리머의 이름, 역할, 미션 내용을 편집 버튼(✏️)을 클릭하여 수정할 수 있습니다.</li>
      <li>프로필 이미지를 클릭하여 스트리머의 프로필 사진을 변경할 수 있습니다.</li>
      <li>각 스트리머의 미션 상태를 체크박스로 관리할 수 있습니다.</li>
      <li><strong>업데이트</strong> 버튼을 클릭하면 해당 스트리머의 미션 현황판이 실시간으로 업데이트됩니다.</li>
      <li>스트리머는 OBS에 미션 현황판 링크를 브라우저 소스로 추가하면 됩니다.</li>
    </ol>
  </div>
  <div class="container">
    <!-- 견자희 카드 -->
    <div class="streamer-card" data-streamer-id="kyeonjahee">
      <div class="streamer-header">
        <div class="streamer-name-container">
          <span class="streamer-name-text editable" contenteditable="false" data-field="name">견자희</span>
        </div>
        <button class="edit-button" onclick="editStreamerName(this)">✏️</button>
      </div>

      <div class="streamer-info">
        <div class="streamer-avatar" onclick="triggerFileUpload('kyeonjahee')">
          <img id="kyeonjahee-avatar" src="#" alt="견자희">
          <div class="avatar-overlay">
            <div class="avatar-overlay-text">클릭하여<br>이미지 변경</div>
          </div>
          <input type="file" id="kyeonjahee-image" class="file-upload" accept="image/*" onchange="uploadImage('kyeonjahee')">
        </div>
        <div class="streamer-details">
          <div class="streamer-role-container">
            <div class="streamer-role">[특이사항]</div>
            <button class="edit-button" onclick="editStreamerRole(this)">✏️</button>
          </div>
          <div class="streamer-name editable" contenteditable="false" data-field="role">모범생</div>
        </div>
      </div>

      <div class="mission-section">
        <div class="mission-category main-mission">
          메인 미션
          <button class="edit-button" onclick="editMissionSection(this, 'main')">✏️</button>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="kyeonjahee-check1" onclick="toggleCheck(this, 'kyeonjahee', 1)"></div>
          <div class="mission-text" data-mission-id="1">선생님 도와주기</div>
        </div>

        <div class="mission-category sub-mission">
          서브 미션
          <button class="edit-button" onclick="editMissionSection(this, 'sub')">✏️</button>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="kyeonjahee-check2" onclick="toggleCheck(this, 'kyeonjahee', 2)"></div>
          <div class="mission-text" data-mission-id="2">발표 3번 하기</div>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="kyeonjahee-check3" onclick="toggleCheck(this, 'kyeonjahee', 3)"></div>
          <div class="mission-text" data-mission-id="3">청소 담당되기</div>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="kyeonjahee-check4" onclick="toggleCheck(this, 'kyeonjahee', 4)"></div>
          <div class="mission-text" data-mission-id="4">반장 선거 출마하기</div>
        </div>
      </div>

      <div class="links-section">
        <div class="links-title">스트리머 OBS 링크</div>
        <div class="link-box" id="kyeonjahee-link">
          https://friendshiping777.github.io/vr-classroom-missions/kyeonjahee.html
        </div>
        <button class="copy-button" onclick="copyToClipboard('kyeonjahee-link')">복사</button>

        <div class="control-buttons">
          <button class="update-button" onclick="updateStreamer('kyeonjahee')">업데이트</button>
          <button class="reset-button" onclick="resetStreamer('kyeonjahee')">초기화</button>
        </div>
      </div>
    </div>

    <!-- 우정잉 카드 -->
    <div class="streamer-card" data-streamer-id="woojeong">
      <div class="streamer-header">
        <div class="streamer-name-container">
          <span class="streamer-name-text editable" contenteditable="false" data-field="name">우정잉</span>
        </div>
        <button class="edit-button" onclick="editStreamerName(this)">✏️</button>
      </div>

      <div class="streamer-info">
        <div class="streamer-avatar" onclick="triggerFileUpload('woojeong')">
          <img id="woojeong-avatar" src="./woojeong.png" alt="우정잉">
          <div class="avatar-overlay">
            <div class="avatar-overlay-text">클릭하여<br>이미지 변경</div>
          </div>
          <input type="file" id="woojeong-image" class="file-upload" accept="image/*" onchange="uploadImage('woojeong')">
        </div>
        <div class="streamer-details">
          <div class="streamer-role-container">
            <div class="streamer-role">[특이사항]</div>
            <button class="edit-button" onclick="editStreamerRole(this)">✏️</button>
          </div>
          <div class="streamer-name editable" contenteditable="false" data-field="role">일진</div>
        </div>
      </div>

      <div class="mission-section">
        <div class="mission-category main-mission">
          메인 미션
          <button class="edit-button" onclick="editMissionSection(this, 'main')">✏️</button>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="woojeong-check1" onclick="toggleCheck(this, 'woojeong', 1)"></div>
          <div class="mission-text" data-mission-id="1">1명 올리기</div>
        </div>

        <div class="mission-category sub-mission">
          서브 미션
          <button class="edit-button" onclick="editMissionSection(this, 'sub')">✏️</button>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="woojeong-check2" onclick="toggleCheck(this, 'woojeong', 2)"></div>
          <div class="mission-text" data-mission-id="2">수업 시간에 노래 부르기</div>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="woojeong-check3" onclick="toggleCheck(this, 'woojeong', 3)"></div>
          <div class="mission-text" data-mission-id="3">아유 받기</div>
        </div>
        <div class="mission-item">
          <div class="mission-checkbox" id="woojeong-check4" onclick="toggleCheck(this, 'woojeong', 4)"></div>
          <div class="mission-text" data-mission-id="4">반장 선거 2표 받기</div>
        </div>
      </div>

      <div class="links-section">
        <div class="links-title">스트리머 OBS 링크</div>
        <div class="link-box" id="woojeong-link">
          https://friendshiping777.github.io/vr-classroom-missions/woojeong.html
        </div>
        <button class="copy-button" onclick="copyToClipboard('woojeong-link')">복사</button>

        <div class="control-buttons">
          <button class="update-button" onclick="updateStreamer('woojeong')">업데이트</button>
          <button class="reset-button" onclick="resetStreamer('woojeong')">초기화</button>
        </div>
      </div>
    </div>
  </div> <!-- container 끝 -->

  <script>
    const AUTO_REFRESH_INTERVAL = 2000;

    window.addEventListener('load', function () {
      const streamers = ['kyeonjahee', 'woojeong', 'mingyeolhui', 'jjamtasua', 'jini', 'manggurang', 'mygomi'];

      streamers.forEach(streamerId => {
        const linkElement = document.getElementById(`${streamerId}-link`);
        if (linkElement) {
          const baseUrl = `https://friendshiping777.github.io/vr-classroom-missions/${streamerId}.html`;
          linkElement.innerText = baseUrl;
        }

        loadStreamerData(streamerId);
        updateStreamerData(streamerId);
      });
    });

    function toggleCheck(element, streamerId, checkNum) {
      element.classList.toggle('checked');
      updateStreamerData(streamerId);
    }

    function editMissionSection(buttonElement, type) {
      const card = buttonElement.closest('.streamer-card');
      const streamerId = card.getAttribute('data-streamer-id');

      let missionElements;
      if (type === 'main') {
        missionElements = [card.querySelector('.mission-text[data-mission-id="1"]')];
      } else {
        missionElements = [
          card.querySelector('.mission-text[data-mission-id="2"]'),
          card.querySelector('.mission-text[data-mission-id="3"]'),
          card.querySelector('.mission-text[data-mission-id="4"]')
        ];
      }

      const isEditing = missionElements[0].contentEditable === 'true';

      if (isEditing) {
        missionElements.forEach(element => {
          if (element) {
            element.contentEditable = 'false';
            element.style.outline = 'none';
            element.style.backgroundColor = '';
          }
        });
        buttonElement.textContent = '✏️';
        updateStreamerData(streamerId);
      } else {
        missionElements.forEach(element => {
          if (element) {
            element.contentEditable = 'true';
            element.style.outline = '2px solid #2b5797';
            element.style.backgroundColor = '#f0f0f0';
          }
        });
        missionElements[0].focus();
        buttonElement.textContent = '💾';

        missionElements.forEach(element => {
          if (element) {
            element.addEventListener('keydown', function (e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                buttonElement.click();
              }
            }, { once: true });
          }
        });
      }
    }

    function editStreamerName(buttonElement) {
      const card = buttonElement.closest('.streamer-card');
      const streamerId = card.getAttribute('data-streamer-id');
      const nameElement = card.querySelector('.streamer-name-text');

      const isEditing = nameElement.contentEditable === 'true';

      if (isEditing) {
        nameElement.contentEditable = 'false';
        nameElement.style.outline = 'none';
        nameElement.style.backgroundColor = '';
        buttonElement.textContent = '✏️';
        updateStreamerData(streamerId);
      } else {
        nameElement.contentEditable = 'true';
        nameElement.style.outline = '2px solid #2b5797';
        nameElement.style.backgroundColor = '#f0f0f0';
        nameElement.focus();
        buttonElement.textContent = '💾';

        nameElement.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            buttonElement.click();
          }
        }, { once: true });
      }
    }

    function editStreamerRole(buttonElement) {
      const card = buttonElement.closest('.streamer-card');
      const streamerId = card.getAttribute('data-streamer-id');
      const roleElement = card.querySelector('.streamer-name[data-field="role"]');

      const isEditing = roleElement.contentEditable === 'true';

      if (isEditing) {
        roleElement.contentEditable = 'false';
        roleElement.style.outline = 'none';
        roleElement.style.backgroundColor = '';
        buttonElement.textContent = '✏️';
        updateStreamerData(streamerId);
      } else {
        roleElement.contentEditable = 'true';
        roleElement.style.outline = '2px solid #2b5797';
        roleElement.style.backgroundColor = '#f0f0f0';
        roleElement.focus();
        buttonElement.textContent = '💾';

        roleElement.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            buttonElement.click();
          }
        }, { once: true });
      }
    }

    function triggerFileUpload(streamerId) {
      document.getElementById(`${streamerId}-image`).click();
    }

    function uploadImage(streamerId) {
      const fileInput = document.getElementById(`${streamerId}-image`);
      const file = fileInput.files[0];

      if (!file) return;
      if (!file.type.match('image.*')) {
        showToast('오류: 이미지 파일만 업로드 가능합니다.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const imageData = e.target.result;
        document.getElementById(`${streamerId}-avatar`).src = imageData;
        updateStreamerData(streamerId);
        showToast('프로필 이미지가 업데이트되었습니다.');
      };
      reader.readAsDataURL(file);
    }

    function copyToClipboard(elementId) {
      const text = document.getElementById(elementId).innerText;
      navigator.clipboard.writeText(text)
        .then(() => showToast('링크가 복사되었습니다.'))
        .catch(err => console.error('클립보드 복사 실패:', err));
    }

    function showToast(message) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 500);
      }, 2000);
    }
  </script>
  <script>
    // Firebase 실시간 데이터 저장
    function updateStreamerData(streamerId) {
      const card = document.querySelector(`[data-streamer-id="${streamerId}"]`);
      const name = card.querySelector('.streamer-name-text').textContent;
      const role = card.querySelector('.streamer-name[data-field="role"]').textContent;
      const mission1 = card.querySelector('.mission-text[data-mission-id="1"]').textContent;
      const mission2 = card.querySelector('.mission-text[data-mission-id="2"]').textContent;
      const mission3 = card.querySelector('.mission-text[data-mission-id="3"]').textContent;
      const mission4 = card.querySelector('.mission-text[data-mission-id="4"]').textContent;
      const check1 = card.querySelector(`#${streamerId}-check1`).classList.contains('checked') ? '1' : '0';
      const check2 = card.querySelector(`#${streamerId}-check2`).classList.contains('checked') ? '1' : '0';
      const check3 = card.querySelector(`#${streamerId}-check3`).classList.contains('checked') ? '1' : '0';
      const check4 = card.querySelector(`#${streamerId}-check4`).classList.contains('checked') ? '1' : '0';
      const imageData = document.getElementById(`${streamerId}-avatar`).src;

      const data = {
        name, role,
        mission1, mission2, mission3, mission4,
        check1, check2, check3, check4,
        image: imageData,
        lastUpdate: Date.now()
      };

      db.ref(`streamers/${streamerId}`).set(data);
    }

    // Firebase 데이터 불러오기
    function loadStreamerData(streamerId) {
      db.ref(`streamers/${streamerId}`).on('value', snapshot => {
        const data = snapshot.val();
        if (!data) return;
        const card = document.querySelector(`[data-streamer-id="${streamerId}"]`);

        card.querySelector('.streamer-name-text').textContent = data.name || '';
        card.querySelector('.streamer-name[data-field="role"]').textContent = data.role || '';
        card.querySelector('.mission-text[data-mission-id="1"]').textContent = data.mission1 || '';
        card.querySelector('.mission-text[data-mission-id="2"]').textContent = data.mission2 || '';
        card.querySelector('.mission-text[data-mission-id="3"]').textContent = data.mission3 || '';
        card.querySelector('.mission-text[data-mission-id="4"]').textContent = data.mission4 || '';

        ['1', '2', '3', '4'].forEach(num => {
          const box = card.querySelector(`#${streamerId}-check${num}`);
          if (data[`check${num}`] === '1') box.classList.add('checked');
          else box.classList.remove('checked');
        });

        if (data.image) {
          const imageElement = card.querySelector(`#${streamerId}-avatar`);
          imageElement.src = data.image + '?t=' + new Date().getTime();
        }
      });
    }

    function updateStreamer(streamerId) {
      updateStreamerData(streamerId);
      showToast('미션 현황판이 업데이트되었습니다.');
    }

    function resetStreamer(streamerId) {
      const card = document.querySelector(`[data-streamer-id="${streamerId}"]`);
      card.querySelector(`#${streamerId}-check1`).classList.remove('checked');
      card.querySelector(`#${streamerId}-check2`).classList.remove('checked');
      card.querySelector(`#${streamerId}-check3`).classList.remove('checked');
      card.querySelector(`#${streamerId}-check4`).classList.remove('checked');
      updateStreamerData(streamerId);
      showToast('미션 현황판이 초기화되었습니다.');
    }
  </script>
</body>
</html>
